import{r as h,j as e,b as a,y,c as C,F as k,I as F,e as P,E,w as A,H as O,a as j,N as S,h as L,A as T,d as $,g as q}from"./index-CT1dYHP2.js";const I=({order:t,onClose:x,onUpdate:v})=>{const[n,u]=h.useState({user_id:"",delivery_address:"",payment_method:"cash",status:"PENDING",total_amt:0,products:[]});h.useEffect(()=>{t&&u({user_id:t.user_id,delivery_address:t.delivery_address||"",payment_method:t.metodo_de_pago||"cash",status:t.status,total_amt:t.total_amt,products:t.products||[]})},[t]);const p=async r=>{var c,s;if(r.preventDefault(),["user_id","status","total_amt","payment_method"].some(i=>!n[i]))return y.error("Complete los campos requeridos");try{const i={...n,metodo_de_pago:n.payment_method,products:n.products.map(o=>({product_id:o.product_id,quantity:o.quantity,price:o.price}))};(await C.put(`https://cloudflare-d1.ujhuji.workers.dev/api/orders/${t.order_id}`,i,{headers:{Authorization:`Bearer ${sessionStorage.getItem("authToken")}`}})).data.success&&(y.success("Orden actualizada!"),v(),x())}catch(i){y.error(((s=(c=i.response)==null?void 0:c.data)==null?void 0:s.error)||"Error al actualizar")}},N=(r,d,c)=>{const s=[...n.products];s[r][d]=d==="quantity"?parseInt(c):c,u({...n,products:s})};return e("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:a("div",{className:"bg-white p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e("button",{className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700",onClick:x,children:"✕"}),a("h2",{className:"text-xl font-bold mb-4",children:["Editar Orden #",t==null?void 0:t.order_id]}),a("form",{onSubmit:p,className:"space-y-4",children:[a("div",{className:"grid grid-cols-2 gap-4",children:[a("div",{children:[e("label",{className:"block mb-2",children:"Estado"}),a("select",{value:n.status,onChange:r=>u(d=>({...d,status:r.target.value})),className:"w-full p-2 border rounded",children:[e("option",{value:"PENDING",children:"Pendiente"}),e("option",{value:"COMPLETED",children:"Completada"}),e("option",{value:"CANCELLED",children:"Cancelada"})]})]}),a("div",{children:[e("label",{className:"block mb-2",children:"Método de Pago"}),a("select",{value:n.payment_method,onChange:r=>u(d=>({...d,payment_method:r.target.value})),className:"w-full p-2 border rounded",children:[e("option",{value:"cash",children:"Efectivo"}),e("option",{value:"paypal",children:"PayPal"}),e("option",{value:"card",children:"Tarjeta"})]})]}),a("div",{children:[e("label",{className:"block mb-2",children:"Total"}),e("input",{type:"number",value:n.total_amt,onChange:r=>u(d=>({...d,total_amt:parseFloat(r.target.value)})),className:"w-full p-2 border rounded",min:"0",step:"0.01",required:!0})]})]}),a("div",{children:[e("label",{className:"block mb-2",children:"Dirección de Entrega"}),e("textarea",{value:n.delivery_address,onChange:r=>u(d=>({...d,delivery_address:r.target.value})),className:"w-full p-2 border rounded",rows:"3"})]}),a("div",{children:[e("h3",{className:"font-bold mb-2",children:"Productos"}),n.products.map((r,d)=>e("div",{className:"border p-3 rounded mb-2",children:a("div",{className:"grid grid-cols-3 gap-4",children:[a("div",{children:[e("label",{children:"Cantidad"}),e("input",{type:"number",value:r.quantity,onChange:c=>N(d,"quantity",c.target.value),className:"w-full p-1 border rounded"})]}),a("div",{children:[e("label",{children:"Precio Unitario"}),e("input",{type:"number",value:r.price,onChange:c=>N(d,"price",c.target.value),className:"w-full p-1 border rounded",step:"0.01"})]}),a("div",{children:[e("label",{children:"Total"}),e("input",{type:"number",value:(r.quantity*r.price).toFixed(2),className:"w-full p-1 border rounded bg-gray-100",readOnly:!0})]})]})},d))]}),a("div",{className:"flex justify-end gap-2",children:[e("button",{type:"button",onClick:x,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Cancelar"}),e("button",{type:"submit",className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Guardar Cambios"})]})]})]})})},z=({order:t,onClose:x})=>{var p,N,r,d,c;if(!t)return null;const v=s=>{const i={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"};return new Date(s).toLocaleDateString("es-ES",i)},n=s=>{const i=s.unit_price*s.quantity*s.discount/100;return{percentage:s.discount,amount:i,originalTotal:s.unit_price*s.quantity,finalPrice:s.total_price}},u=s=>!s||Object.keys(s).length===0?null:a("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg border",children:[e("h4",{className:"font-semibold mb-3 text-blue-600 text-sm",children:"Detalles Específicos:"}),e("div",{className:"grid grid-cols-2 gap-3",children:Object.entries(s).map(([i,g])=>a("div",{className:"flex items-center justify-between border-b pb-2",children:[a("span",{className:"capitalize text-gray-600 font-medium text-sm",children:[i.replace(/_/g," "),":"]}),typeof g=="string"&&g.startsWith("http")?e("img",{src:g,alt:i,className:"w-14 h-14 object-cover rounded-lg border shadow-sm"}):e("span",{className:"text-gray-800 text-sm",children:g})]},i))})]});return e("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:a("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl relative max-h-[90vh] overflow-y-auto",children:[e("button",{className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700",onClick:x,children:"✕"}),a("div",{className:"text-center mb-6",children:[a("h2",{className:"text-2xl font-bold text-blue-600",children:["Detalles Completo del Pedido #",t.order_id]}),e("p",{className:"text-sm text-gray-500 mt-2",children:v(t.created_at)})]}),a("div",{className:"bg-gray-50 p-4 rounded-lg mb-6",children:[a("h3",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(k,{className:"text-blue-500"})," Información del Cliente"]}),a("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a("div",{children:[e("p",{className:"font-medium",children:"Nombre:"}),e("p",{children:t.user_name})]}),a("div",{children:[e("p",{className:"font-medium",children:"Email:"}),a("p",{className:"text-blue-600 break-all",children:[e(F,{className:"inline mr-2"}),t.user_email]})]})]})]}),a("div",{className:"bg-gray-50 p-4 rounded-lg mb-6",children:[a("h3",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(P,{className:"text-blue-500"})," Dirección de Entrega"]}),t.address?a("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a("div",{children:[e("p",{className:"font-medium",children:"Dirección:"}),e("p",{children:((p=t.address)==null?void 0:p.address_line)||"N/A"})]}),a("div",{children:[e("p",{className:"font-medium",children:"Ciudad/Estado:"}),a("p",{children:[((N=t.address)==null?void 0:N.city)||"N/A",", ",((r=t.address)==null?void 0:r.state)||"N/A"]})]}),a("div",{children:[e("p",{className:"font-medium",children:"Código Postal:"}),e("p",{children:((d=t.address)==null?void 0:d.pincode)||"N/A"})]}),a("div",{children:[e("p",{className:"font-medium",children:"Teléfono:"}),e("p",{children:((c=t.address)==null?void 0:c.mobile)||"N/A"})]})]}):e("p",{className:"text-red-500",children:"Dirección no disponible"})]}),e("div",{className:`p-4 rounded-lg mb-6 ${t.status==="CANCELLED"?"bg-red-100":t.status==="COMPLETED"?"bg-green-100":"bg-yellow-100"}`,children:a("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e(E,{className:"text-purple-500"})," Estado Actual:",e("span",{className:`px-3 py-1 rounded-full text-sm ${t.status==="CANCELLED"?"bg-red-200 text-red-800":t.status==="COMPLETED"?"bg-green-200 text-green-800":"bg-yellow-200 text-yellow-800"}`,children:t.status})]})}),a("div",{className:"mb-6",children:[a("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e(E,{className:"text-green-500"})," Productos Adquiridos"]}),e("div",{className:"space-y-4",children:t.items.map((s,i)=>{const g=Array.isArray(s.image)?s.image:JSON.parse(s.image||"[]"),o=n(s),f=s.more_details||{};return a("div",{className:"border rounded-lg p-4",children:[e("div",{className:"flex gap-4 mb-3 flex-wrap",children:g.map((w,_)=>e("img",{src:w,alt:s.name,className:"w-20 h-20 object-cover rounded border"},_))}),a("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[a("div",{children:[e("p",{className:"font-medium",children:"Producto:"}),e("p",{className:"font-semibold",children:s.name})]}),a("div",{children:[e("p",{className:"font-medium",children:"Precio Unitario:"}),a("p",{children:["$",parseFloat(s.unit_price).toFixed(2)]})]}),a("div",{children:[e("p",{className:"font-medium",children:"Cantidad:"}),e("p",{children:s.quantity})]}),a("div",{children:[e("p",{className:"font-medium",children:"Total:"}),a("p",{className:"text-green-600 font-bold",children:["$",s.total_price.toFixed(2)]})]})]}),f&&Object.keys(f).length>0&&u(f),s.discount>0&&e("div",{className:"mt-4 bg-blue-50 p-3 rounded-lg",children:a("p",{className:"font-semibold text-blue-800",children:["Descuento aplicado: ",o.percentage,"%",a("span",{className:"block text-sm font-normal",children:["(Ahorro: $",o.amount.toFixed(2),")"]})]})})]},i)})})]}),a("div",{className:"bg-blue-50 p-4 rounded-lg",children:[a("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e(A,{className:"text-green-500"})," Resumen Financiero"]}),a("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a("div",{children:[e("p",{className:"font-medium",children:"Total de Productos:"}),e("p",{children:t.items.length})]}),a("div",{children:[e("p",{className:"font-medium",children:"Total General:"}),a("p",{className:"text-2xl font-bold text-blue-600",children:["$",t.total_amt.toFixed(2)]})]})]})]}),e("div",{className:"mt-6 flex justify-end",children:a("button",{onClick:()=>window.print(),className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2",children:[e(O,{})," Imprimir Comprobante"]})})]})})},B=()=>{const{user:t}=j(),[x,v]=h.useState([]),[n,u]=h.useState([]),[p,N]=h.useState(""),[r,d]=h.useState(!0),[c,s]=h.useState(null),[i,g]=h.useState(null),[o,f]=h.useState(null),w=async()=>{var l,m;try{const b=await C.get("https://cloudflare-d1.ujhuji.workers.dev/api/orders",{headers:{Authorization:`Bearer ${sessionStorage.getItem("authToken")}`}});b.data.success&&(v(b.data.data),u(b.data.data))}catch(b){y.error(((m=(l=b.response)==null?void 0:l.data)==null?void 0:m.error)||"Error al cargar órdenes")}finally{d(!1)}};h.useEffect(()=>{(t==null?void 0:t.role)==="ADMIN"&&w()},[t]),h.useEffect(()=>{const l=x.filter(m=>m.order_id.toString().includes(p)||m.user_name&&m.user_name.toLowerCase().includes(p.toLowerCase())||m.status.toLowerCase().includes(p.toLowerCase())||new Date(m.created_at).toLocaleDateString("es-ES").includes(p));u(l)},[p,x]);const _=async()=>{var l,m;try{if((o==null?void 0:o.status)!=="CANCELLED"){y.error("La orden debe estar cancelada antes de eliminarla");return}await C.delete(`https://cloudflare-d1.ujhuji.workers.dev/api/orders/${o.order_id}`,{headers:{Authorization:`Bearer ${sessionStorage.getItem("authToken")}`}}),v(b=>b.filter(D=>D.order_id!==o.order_id)),y.success(`Orden #${o.order_id} eliminada`)}catch(b){y.error(((m=(l=b.response)==null?void 0:l.data)==null?void 0:m.error)||"Error al eliminar orden")}finally{f(null)}};return!t||t.role!=="ADMIN"?e(S,{to:"/"}):r?e("div",{className:"flex justify-center items-center h-screen",children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):a("div",{className:"max-w-6xl mx-auto p-4",children:[e("h1",{className:"text-3xl font-bold mb-8 text-gray-800",children:"Gestión de Órdenes"}),e("input",{type:"text",placeholder:"Buscar por ID, usuario, fecha o estado...",value:p,onChange:l=>N(l.target.value),className:"w-full p-2 mb-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"}),c&&e(I,{order:c,onClose:()=>s(null),onUpdate:w}),e(z,{order:i,onClose:()=>g(null)}),o&&a(L,{children:[e("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-40 transition-opacity"}),e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:a("div",{className:"bg-white rounded-xl p-6 max-w-md w-full shadow-2xl",children:[e("h3",{className:"text-lg font-bold mb-3",children:"¿Eliminar orden?"}),e("p",{className:"text-gray-600 mb-5",children:"Esta acción no se puede deshacer"}),a("div",{className:"flex justify-end gap-3",children:[e("button",{onClick:()=>f(null),className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:"Cancelar"}),e("button",{onClick:_,className:"px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg transition-colors",children:"Confirmar"})]})]})})]}),e("div",{className:"overflow-x-auto bg-white rounded-lg shadow-md",children:a("table",{className:"min-w-full",children:[e("thead",{className:"bg-gray-100",children:a("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ID"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuario"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Método de Pago"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:n.map(l=>{var m;return a("tr",{children:[a("td",{className:"px-6 py-4 whitespace-nowrap",children:["#",l.order_id]}),e("td",{className:"px-6 py-4 whitespace-nowrap",children:l.user_name||"Desconocido"}),e("td",{className:"px-6 py-4 whitespace-nowrap",children:new Date(l.created_at).toLocaleDateString("es-ES")}),a("td",{className:"px-6 py-4 whitespace-nowrap",children:["$",(m=l.total_amt)==null?void 0:m.toFixed(2)]}),e("td",{className:"px-6 py-4 whitespace-nowrap",children:e("span",{className:`px-2 py-1 rounded-full text-xs ${l.status==="PENDING"?"bg-yellow-100 text-yellow-800":l.status==="COMPLETED"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:l.status})}),e("td",{className:"px-6 py-4 whitespace-nowrap",children:l.metodo_de_pago==="cash"?"Cash":l.payment_id?"PayPal":"No especificado"}),a("td",{className:"px-6 py-4 whitespace-nowrap space-x-2",children:[e("button",{onClick:()=>g(l),className:"text-blue-600 hover:text-blue-900 p-1",children:e(T,{size:18})}),e("button",{onClick:()=>s(l),className:"text-green-600 hover:text-green-900 p-1",children:e($,{size:18})}),e("button",{onClick:()=>f(l),className:"text-red-600 hover:text-red-900 p-1",children:e(q,{size:18})})]})]},l.order_id)})})]})})]})};export{B as default};
